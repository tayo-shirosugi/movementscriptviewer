# MovementScript Viewer

Beat Saberのカメラムーブメントスクリプトを3Dで可視化・分析するためのWebベースのツールです。

## 概要

MovementScript Viewerは、JSONファイルからカメラの動きのデータを読み込み、3D空間で可視化するスタンドアロンのHTMLアプリケーションです。カメラの移動経路、回転、視野角(FOV)の変化をインタラクティブにプレビューできます。

## 機能

- **3D可視化**: Three.jsによるリアルタイム3Dレンダリング
- **複数スクリプトの同時表示**: 複数のJSONファイルを同時に読み込み、色分けして比較表示
- **カメラパスプレビュー**: カメラの位置と回転の変化を視覚化
- **インタラクティブなタイムライン**: タイムラインのスクラブ再生や自動再生
- **再生コントロール**: 
  - 再生/一時停止機能
  - 再生速度調整(0.1倍〜5.0倍)
  - 手動タイムラインスクラブ
- **VRMアバター対応**: VRMファイル（.vrm, .nvrm）を読み込み、指定のスケールで表示（自動的にカメラ側を向くように補正）
- **SRT字幕同期**: 歌詞や字幕（.srt）を音楽に合わせて表示し、個別に同期タイミングを調整可能（オフセット・スケール）
- **DRAG & DROP / AUTO DETECTION**: 複数のファイル（JSON, VRM, Music, SRT）をまとめてドラッグして簡単にロード。拡張子が正しくない場合（.txtなど）でも内容からJSON（スクリプト）やSRT（字幕）を自動判別。
- **視覚的インジケーター**:
  - カメラ視錐台の可視化 (上面:黄色、下面:青色)
  - 地面へのカメラXZ位置投影マーカー
  - 高さ可視化のための垂直グリッドマーカー (前面、左、右)
  - **AxesHelper**: ワールド座標軸 (X:赤, Y:緑, Z:青) の表示
  - **Crosshairs**: 全てのグリッド面上でカメラの絶対位置・向き・ロールを示すシアン色の十字線
  - Beat Saber風の方向マーカー (左:赤、右:青)
- **Camera Effects (Wipe, DoF, Outline, Glitch)**: エフェクトの進行状況をプレビューおよびメイン画面でリアルタイムに可視化
  - **Wipe**: 円形（Iris/Circle）および方向指定（Left to Right, Right to Left, Top to Bottom, Bottom to Top）に対応
  - **DoF (Depth of Field)**: 被写界深度によるボケ表現のシミュレーション
  - **Outline**: ラプラシアンフィルタによるエッジ抽出と背面色の混合
  - **Glitch**: 色ずれ(RGB Split)、ジッター(Slicing)、スキャンライン(Scanlines)の複合表現
- **リアルタイムカメラステータス表示**:
  - 各スクリプトの個別の位置・回転・FOV・エフェクト情報の詳細表示
  - グローバルなタイムライン制御およびシンク設定
- **メインカメラ切り替え**: 各スクリプトのプレビュー画面をクリックすることで、メインビューをそのカメラの視点に容易に切り替え可能

## 使い方

### 必要な環境

インストール不要！ブラウザだけで動作します。以下のライブラリはCDNから自動的に読み込まれます:
- Three.js (v0.170.0)
- Tweakpane (v4.0.3)
- @pixiv/three-vrm (v3.0.0)

### 使用方法

1. `MovementScriptViewer.html`をモダンブラウザで開く
2. ファイルをドラッグアンドドロップするか、クリックして選択:
   - JSONファイル（カメラスクリプト）
   - オプション: VRMファイル（アバター） - 自動的にロードされ、真正面（Three.js空間の-Z方向、アバターには鼻マーカーが付与されます）を向きます
   - オプション: 音楽ファイル（ogg, mp3, wav, egg）
   - オプション: 字幕ファイル（.srt）
3. 初期画面の「Sync Settings」で、ScriptとSRTそれぞれのオフセット(秒)やスケールを必要に応じて調整
4. 「Play」ボタンをクリックして再生開始
5. コントロールパネルおよび画面上の操作:
   - アニメーションの再生/一時停止
   - タイムラインのスクラブ
   - 再生速度および**音量**の調整
   - **Add Lyrics (.srt)**: 再生中にも追加の字幕ファイルを読み込み可能
   - カメラステータス情報の確認（Wipe, DoF, Outline, Glitchの各パラメータ含む）
   - **プレビュークリック**: メイン画面をそのカメラの視点に切り替え
   - **Back to Menu**: 画面左上のボタンで初期画面に戻り、設定を変更して再プレイ

## データフォーマット

ビューアは以下の構造のJSONファイルを想定しています:

```json
{
  "ActiveInPauseMenu": true,
  "TurnToHeadUseCameraSetting": false,
  "Movements": [
    {
      "StartPos": { "x": 0, "y": 3, "z": -7, "FOV": 60 },
      "StartRot": { "x": 20, "y": 0, "z": 0 },
      "StartHeadOffset": { "x": 0, "y": 0, "z": 0 },
      "EndPos": { "x": 1.352, "y": 2.971, "z": -6.811, "FOV": 60 },
      "EndRot": { "x": 19.765, "y": -9.818, "z": 0 },
      "EndHeadOffset": { "x": 0, "y": 0, "z": 0 },
      "TurnToHead": false,
      "TurnToHeadHorizontal": false,
      "Duration": 0.522,
      "Delay": 0,
      "EaseTransition": false,
      "VisibleObject": { ... },
      "CameraEffect": {
         "enableDoF": true,
         "StartDoF": { "dofBlurRadius": 0 },
         "EndDoF": { "dofBlurRadius": 5.0 },
         "WipeType": "Circle",
         "StartWipe": { "wipeProgress": 0, "wipeCircleCenter": { "x": 0, "y": 0 } },
         "EnableOutlineEffect": true,
         "StartOutline": { "outlineColor": { "r": 0, "g": 1, "b": 1 }, "outlineEffectOnly": 0 },
         "EnableGlitchEffect": true,
         "StartGlitch": { "colorGap": 0.02, "glitchScale": 1.0, "frequency": 0.1 }
      }
    }
  ]
}
```

### ムーブメントプロパティ

- **StartPos/EndPos**: カメラ位置(X, Y, Z座標とFOV)
- **StartRot/EndRot**: カメラ回転(ピッチ、ヨー、ロール/度数)
- **Duration**: ムーブメントの継続時間(秒)
- **Delay**: ムーブメント開始前の遅延時間
- **EaseTransition**: スムーズな遷移のためのイージングを使用するか
- **CameraEffect**: 各種エフェクト（DoF, Wipe, Outline, Glitch）の個別パラメータ指定

## 座標系

ビューアはUnityの左手座標系をThree.jsの右手座標系に変換します:
- **Unity**: X+(右), Y+(上), Z+(前)
- **Three.js**: X+(右), Y+(上), Z-(前)
- **補正**: JSONのZ値は符号反転され、回転は 'YXZ' 順序のクォータニオンとして処理されます。

## ビジュアル要素

### カメラの表現
- **ピラミッド型視錐台**: カメラの視線方向を表示
  - 黄色の面: 視界の上部
  - 青色の面: 視界の下部
  - グレーのワイヤーフレーム: 側面
- **白いボックス**: 中心のカメラ本体
- **カメラプレビュー**: プレビューCam用カメラ視野角（アスペクト比16:9）

### グリッドシステム
- **地面グリッド**: Y=0の位置にある20×20の水平グリッド
- **垂直グリッド**: 高さの参照用（前面: Z=-10, 左: X=-10, 右: X=10）

### マーカー
- **地面マーカー**: 地面上のカメラXZ位置と方向を示す黄色の矢印
- **垂直マーカー**: 各垂直グリッド上のカメラ投影位置を示す黄色の矢印
- **十字線**: 各グリッド平面上でカメラの向きとロールを示すシアン色の十字線
- **AxesHelper**: 原点付近のワールド軸を表示

### 方向マーカー
- **赤いボックス**: 左側マーカー (Beat Saber準拠、-X方向)
- **青いボックス**: 右側マーカー (Beat Saber準拠、+X方向)

## コントロール

### ビューアカメラ (Main Viewer)
- デフォルト位置 (0, 2, 5) から原点方向を注視。
- **OrbitControls**: マウス操作で回転、ズーム、パンが自由に行えます。
- プレビュー画面クリックで各スクリプトカメラ視点への切り替えが可能です。

### UIパネル (Tweakpane)
- **Time**: グローバルタイムラインのスクラブ
- **Play / Pause**: 再生の開始/停止
- **Playback Speed**: 再生速度調整(0.1x〜5.0x)
- **Volume**: 音量調整(0.0〜1.0)
- **Avatar Height**: アバターのスケール調整
- **Sync Settings**: スクリプトと字幕の個別タイミング調整（Offset, Scale）
- **Camera folder**: 個別カメラの位置、回転、FOV、およびCamera Effectsの状態詳細表示

## ブラウザ互換性

以下をサポートするモダンブラウザでテスト済み:
- ES6モジュール
- WebGL
- Import Maps

推奨ブラウザ:
- Chrome/Edge(最新版)
- Firefox(最新版)
- Safari(最新版)

## 技術詳細

### 使用ライブラリ
- **Three.js**: 3Dレンダリングエンジン
- **Tweakpane**: UIコントロールパネル

### アーキテクチャ
- 単一ファイルのHTMLアプリケーション
- ビルドプロセス不要
- すべての依存関係はCDN経由で読み込み
- ES6モジュールを使用したモジュラーJavaScript

## ライセンス

このプロジェクトは可視化目的でそのまま提供されています。

## タイル表示用（疑似平行投影）スクリプトの生成

9つのカメラ映像をつなぎ合わせて、歪みのない大きな1つの映像（ビデオウォール）を作るためのスクリプト生成ツールです。
カメラを被写体から遠ざけ、その分FOV（視野角）を狭くする（望遠にする）ことで、パースの歪みを抑え、きれいなタイリングを実現します。

### 使い方

1. Node.jsがインストールされていることを確認してください。
2. `SongScript.json`（オリジナル）が同じディレクトリにあることを確認してください。
3. 以下のコマンドを実行します:

```bash
node generate_tiled_cameras.js
```

これにより、`SongScript/TiledCamera/` フォルダ内に `Tiled_Cam1.json` 〜 `Tiled_Cam9.json` が生成されます。

### 仕組み
- オリジナルのカメラ位置から、指定した距離（デフォルト30m）だけ後ろに下がります。
- 画面上の被写体の大きさが変わらないように、FOVを自動的に狭く（ズーム）します。
- 3x3のグリッド状に配置し、それぞれの映像が隙間なくつながるようにオフセットを計算します。

## 拡張案

必要に応じて自由に改変・拡張してください。改善案の例:
- カメラパスの可視化(全経路を示す線の追加)
- ビューアカメラのコントロール実装(オービットコントロール)
- カメラデータのエクスポート機能
- 追加のムーブメントプロパティのサポート
- VisibleObject設定の可視化

## トラブルシューティング

### ファイルが読み込めない
- JSONファイルが正しくフォーマットされているか確認してください
- ブラウザのコンソールでエラーメッセージを確認してください
- ファイルに"Movements"配列が含まれているか確認してください

### カメラが表示されない
- ムーブメントデータに有効な位置の値が含まれているか確認してください
- 最初のムーブメントに遅延がある場合、タイムスライダーが0になっていないか確認してください
- カメラが可視グリッド領域内にあるか確認してください

### パフォーマンスの問題
- 大きなムーブメントファイル(数千のムーブメント)は動作が遅くなる可能性があります
- 再生速度を下げてみてください
- 非常に大きなファイルは小さなセグメントに分割することを検討してください
